---
- name: Deploy Podman Media Stack with Systemd User Units (uCore Compatible - User Exists)
  hosts: 192.168.50.182 # <-- CHANGE THIS
  gather_facts: yes
  # 'become' is needed for linger, but not most file operations if done in user home
  # We will use become_user for tasks specifically needing the podman_user context

  vars:
    # --- Core Setup ---
    podman_user: "alastor" # Confirmed user exists
    podman_group: "alastor" # Assuming group matches user name and exists
    # user_home_dir will be determined dynamically below
    user_puid: "1001" # Confirmed UID
    user_pgid: "1001" # Confirmed GID
    timezone: "America/New_York" # CHANGE THIS if needed

    # --- Gluetun ---
    vpn_provider: "nordvpn" # CHANGE THIS
    vpn_type: "wireguard" # or openvpn

    # --- Ports (Informational - Firewall not managed here) ---
    endlessh_port: 2222
    portainer_https_port: 9443 # Example: Access via http://<host-ip>:9443

    # --- Secrets (USE ANSIBLE VAULT!) ---
    authelia_session_secret: "{{ authelia_session_secret }}"
    authelia_jwt_secret: "{{ authelia_jwt_secret }}"
    authelia_storage_encryption_key: "{{ authelia_storage_encryption_key }}"
    vault_ionos_api_key: "{{ vault_ionos_api_key }}"

    # --- Tokens ---
    gotify_app_token: "CHANGE_ME_GET_FROM_GOTIFY_UI"

    # --- Service Lists ---
    # (Service lists remain the same as original playbook)
    podman_services:
      - jellyfin
      - stash
      - dozzle
      - crowdsec
      - caddy
      - diun
      - scrutiny
      - uptime-kuma
      - jellyseerr
      - infra # Placeholder
      - gluetun
      - radarr
      - sonarr
      - lidarr
      - prowlarr
      - homepage
      - changedetection
      - unbound
      - godns
      - jackett
      - flaresolverr
      - endlessh
      - qbittorrent
      - sabnzbd
      # - borgmatic # Ensure compose file handles volumes correctly if enabled
      - authelia
      - gotify
      - portainer

    services_with_data_dirs: # Relative paths under base_data_dir
      - jellyfin/config
      - jellyfin/cache
      - jellyfin/media
      - stash/config
      - stash/generated
      - stash/metadata
      - stash/cache
      - stash/blobs
      - dozzle/config
      - crowdsec/config
      - crowdsec/data
      - caddy/config
      - caddy/data
      - caddy/logs
      - diun/config
      - diun/data
      - scrutiny/config
      - scrutiny/influxdb
      - uptime-kuma/data
      - jellyseerr/config
      - infra/config # Placeholder
      - gluetun/config
      - radarr/config
      - sonarr/config
      - lidarr/config
      - prowlarr/config
      - homepage/config
      - changedetection/data
      - unbound/config
      - jackett/config
      - jackett/downloads
      - flaresolverr/config
      # - endlessh # No data dir typically needed
      - qbittorrent/config
      - sabnzbd/config
      # - borgmatic/config # Check compose volume strategy if enabling
      - authelia/config
      - gotify/data
      - portainer/data
      - godns/config

  pre_tasks:
    - name: Get actual home directory path for existing user '{{ podman_user }}'
      become: yes # Need root to query user info typically
      ansible.builtin.user:
        name: "{{ podman_user }}"
      register: podman_user_info
      check_mode: yes # Just gather info, don't try to modify
      failed_when: not podman_user_info.home # Fail if user doesn't exist or home dir not found
      changed_when: false

    - name: Set user home directory fact
      ansible.builtin.set_fact:
        user_home_dir: "{{ podman_user_info.home }}"
        # Derive base dirs from dynamic home dir path
        base_stack_dir: "{{ podman_user_info.home }}/podman-stacks"
        base_data_dir: "{{ podman_user_info.home }}/podman-data"

    - name: Debug - show effective directories
      ansible.builtin.debug:
        msg:
          - "User home directory: {{ user_home_dir }}"
          - "Stack directory: {{ base_stack_dir }}"
          - "Data directory: {{ base_data_dir }}"

  tasks:
    # --- USER/GROUP CREATION TASKS REMOVED ---

    - name: Ensure linger is enabled for the user '{{ podman_user }}'
      become: yes
      ansible.builtin.command: "loginctl enable-linger {{ podman_user }}"
      changed_when: false # Command itself doesn't report change reliably
      failed_when: false # Don't fail if linger is already enabled

    - name: Ensure base directories exist in user home
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ base_stack_dir }}"
        - "{{ base_data_dir }}"

    - name: Create data subdirectories for services
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.file:
        path: "{{ base_data_dir }}/{{ item }}"
        state: directory
        mode: '0775' # Allow group write if needed by containers
      loop: "{{ services_with_data_dirs }}"

    - name: Create stack subdirectories for compose files
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.file:
        path: "{{ base_stack_dir }}/{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ podman_services }}"

    # --- Template/Copy config files FIRST ---
    # (These tasks remain the same as the previous rework, using the dynamically set base_data_dir)
    - name: Template GoDNS configuration file
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.template:
        src: "stacks/godns/config.yml.j2"
        dest: "{{ base_data_dir }}/godns/config/config.yml"
        mode: '0600'

    - name: Template GoDNS Compose file
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.template:
        src: "stacks/godns/compose.yml.j2"
        dest: "{{ base_stack_dir }}/godns/compose.yml"
        mode: '0644'

    - name: Copy Caddyfile
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.copy:
        src: "stacks/caddy/Caddyfile"
        dest: "{{ base_data_dir }}/caddy/config/Caddyfile"
        mode: '0644'
      notify: Restart Caddy Service # Handler needs become_user

    - name: Template Authelia configuration
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.template:
        src: "stacks/authelia/configuration.yml.j2"
        dest: "{{ base_data_dir }}/authelia/config/configuration.yml"
        mode: '0600'

    - name: Copy Authelia users file
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.copy:
        src: "stacks/authelia/users.yml"
        dest: "{{ base_data_dir }}/authelia/config/users.yml"
        mode: '0600'

    - name: Template Diun compose file
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.template:
        src: "stacks/diun/compose.yml.j2"
        dest: "{{ base_stack_dir }}/diun/compose.yml"
        mode: '0644'

    - name: Copy standard Compose files to target host
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.copy:
        src: "stacks/{{ item }}/compose.yml"
        dest: "{{ base_stack_dir }}/{{ item }}/compose.yml"
        mode: '0644'
      loop: "{{ podman_services | difference(['diun', 'authelia', 'godns']) }}"

    # --- REMOVED firewalld task ---

    # --- Generate Systemd Units ---
    # (This task remains the same as the previous rework, using the dynamically set base_stack_dir and user_home_dir)
    - name: Generate systemd user units for each stack
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.command: >-
        podman generate systemd --new --files --name {{ item }} {{ base_stack_dir }}/{{ item }}/compose.yml
      args:
        chdir: "{{ user_home_dir }}" # Run from user's home
        creates: "{{ user_home_dir }}/.config/systemd/user/{{ item }}.service"
      register: systemd_generate_result
      changed_when: "'Created' in systemd_generate_result.stdout"
      loop: "{{ podman_services }}"
      notify: Reload Systemd User Daemon

  handlers:
    # (Handlers remain the same)
    - name: Reload Systemd User Daemon
      listen: Reload Systemd User Daemon
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.systemd:
        scope: user
        daemon_reload: yes

    - name: Restart Caddy Service
      listen: Restart Caddy Service
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.systemd:
        scope: user
        name: caddy.service
        state: restarted

# --- Final Play Task: Ensure services are running ---
# (This play remains the same)
- name: Ensure Podman services are enabled and started
  hosts: 192.168.50.182# <-- CHANGE THIS
  gather_facts: no

  vars: # Define user again or pass via inventory/extra-vars
    podman_user: "alastor"
    # Define services list again or pass via inventory/extra-vars
    podman_services:
      # (Copy services list here from above if not using inventory/extra-vars)
      - jellyfin
      - stash
      - dozzle
      # ... (rest of services) ...
      - authelia
      - gotify
      - portainer

  tasks:
    - name: Enable and start systemd user units
      become: yes
      become_user: "{{ podman_user }}"
      ansible.builtin.systemd:
        scope: user
        name: "{{ item }}.service"
        enabled: yes
        state: started
      loop: "{{ podman_services }}"

